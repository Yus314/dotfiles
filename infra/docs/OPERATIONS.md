# Infrastructure Operations Guide

## ğŸš€ åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ‰‹é †

### Prerequisitesç¢ºèª
```bash
# å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã®å­˜åœ¨ç¢ºèª
which sops age terraform nix    # å…¨ã¦è¦‹ã¤ã‹ã‚‹ã“ã¨ã‚’ç¢ºèª

# SOPSéµã®ç¢ºèª
ls -la ~/.config/sops/age/keys.txt    # ageéµãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
echo $SOPS_AGE_KEY_FILE               # ç’°å¢ƒå¤‰æ•°è¨­å®šã®ç¢ºèª
```

### tfãƒ©ãƒƒãƒ‘ãƒ¼ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```bash
# åˆå›ã®ã¿å®Ÿè¡Œ
cd infra
scripts/install-tf-wrapper.sh    # PATHã¸ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ä½œæˆ

# ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèª
which tf                          # /usr/local/bin/tf ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
tf --version                      # ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã¨SOPSçµ±åˆç¢ºèª
```

### èªè¨¼ãƒ†ã‚¹ãƒˆ
```bash
# å„ã‚µãƒ¼ãƒ“ã‚¹ã§èªè¨¼ãƒ†ã‚¹ãƒˆ
cd infra/services/cloudflare
tf validate    # SOPSå¾©å·åŒ– + OCIèªè¨¼ã®å‹•ä½œç¢ºèª

cd ../github
tf validate    # GitHubç”¨èªè¨¼ç¢ºèª
```

**âœ… ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—å®Œäº†ã®ç¢ºèª**: å…¨ã¦ã®ã‚³ãƒãƒ³ãƒ‰ãŒã‚¨ãƒ©ãƒ¼ãªãå®Œäº†ã™ã‚‹ã“ã¨

---

## ğŸ“‹ æ¨™æº–é‹ç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

### Phase 1: å¤‰æ›´è¨ˆç”»
```bash
# 1. ç¾åœ¨ã®çŠ¶æ³ç¢ºèª
cd infra/services/{service}
tf plan    # ç¾åœ¨ã®å·®åˆ†ç¢ºèªï¼ˆé€šå¸¸ã¯No changesãŒè¡¨ç¤ºã•ã‚Œã‚‹ï¼‰

# 2. è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç·¨é›†
# main.tf, secrets.yamlç­‰ã‚’ç·¨é›†

# 3. æ§‹æ–‡æ¤œè¨¼
tf validate
```

### Phase 2: å½±éŸ¿ç¢ºèª
```bash
# 4. å¤‰æ›´å†…å®¹ã®è©³ç´°ç¢ºèª
tf plan    # ğŸ” å¿…ãšå®Ÿè¡Œã—ã€å¤‰æ›´å†…å®¹ã‚’è©³ç´°ã«ç¢ºèª
```

**âš ï¸ STOP**: planã®çµæœã‚’**å¿…ãšäººé–“ãŒç¢ºèª**ã—ã¦ã‹ã‚‰æ¬¡ã¸é€²ã‚€

### Phase 3: æœ¬ç•ªé©ç”¨
```bash
# 5. æ‰¿èªå¾Œã®é©ç”¨
tf apply    # å†åº¦ç¢ºèªãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹

# 6. é©ç”¨çµæœã®ç¢ºèª
tf plan     # No changesãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆå†ªç­‰æ€§ç¢ºèªï¼‰
```

### Phase 4: å¤‰æ›´è¨˜éŒ²
```bash
# 7. å¤‰æ›´ã®ã‚³ãƒŸãƒƒãƒˆ
git add -A
git commit -m "feat(infra): describe your change

- Specific change details
- Business justification
- Impact assessment"
```

---

## ğŸ” æ¤œè¨¼ã¨ãƒ†ã‚¹ãƒˆæ‰‹é †

### terraform planã®èª­ã¿æ–¹
```bash
# æœŸå¾…ã•ã‚Œã‚‹è¡¨ç¤ºä¾‹
tf plan
```
```
No changes. Your infrastructure matches the configuration.
```
**âœ… ç†æƒ³çš„**: æ—¢å­˜ã‚¤ãƒ³ãƒ•ãƒ©ã¨ã®å·®åˆ†ãªã—

```
Plan: 1 to add, 0 to change, 0 to destroy.
```
**âš ï¸ è¦ç¢ºèª**: è¿½åŠ ãƒ»å¤‰æ›´ãƒ»å‰Šé™¤ã®è©³ç´°ã‚’å¿…ãšç¢ºèª

### å¤‰æ›´å†…å®¹ã®å®‰å…¨ç¢ºèª
```bash
# ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–å€¤ã®ç¢ºèª
tf plan | grep "sensitive value"    # æ©Ÿå¯†æƒ…å ±ãŒé©åˆ‡ã«ãƒã‚¹ã‚¯ã•ã‚Œã¦ã„ã‚‹ç¢ºèª

# æ„å›³ã—ãªã„å¤‰æ›´ã®æ¤œå‡º
tf plan | grep -E "(destroy|replace)"    # ç ´å£Šçš„å¤‰æ›´ã®æœ‰ç„¡ç¢ºèª
```

### ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †
```bash
# Git based rollback
git log --oneline -10               # æœ€è¿‘ã®ã‚³ãƒŸãƒƒãƒˆç¢ºèª
git revert HEAD                     # ç›´å‰å¤‰æ›´ã®å–ã‚Šæ¶ˆã—
tf plan && tf apply                 # ã‚¤ãƒ³ãƒ•ãƒ©çŠ¶æ…‹ã®å¾©å…ƒ

# ç·Šæ€¥æ™‚ã®å¼·åˆ¶ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
git reset --hard HEAD~1             # å±é™º: æœªã‚³ãƒŸãƒƒãƒˆå¤‰æ›´ã‚‚æ¶ˆå¤±
tf plan && tf apply                 # å¼·åˆ¶çŠ¶æ…‹å¾©å…ƒ
```

---

ã“ã®ã‚¬ã‚¤ãƒ‰ã«å¾“ã†ã“ã¨ã§ã€**å®‰å…¨ã§åŠ¹ç‡çš„ãªã‚¤ãƒ³ãƒ•ãƒ©é‹ç”¨**ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚
